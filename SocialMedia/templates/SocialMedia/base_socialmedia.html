{% extends 'base_main.html' %}
{% load static %}
{% load widget_tweaks %}


{% block stylesheets %}
    {{ block.super }}

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- ==== Document Title ==== -->
    <title> {% block title %}Réseau social - {% endblock title %}</title>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/brands.css" integrity="sha384-n9+6/aSqa9lBidZMRCQHTHKJscPq6NW4pCQBiMmHdUCvPN8ZOg2zJJTkC7WIezWv" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/fontawesome.css" integrity="sha384-vd1e11sR28tEK9YANUtpIOdjGW14pS87bUBuOIoBILVWLFnS+MCX9T6MMf0VdPGq" crossorigin="anonymous">


    <!-- ==== Document Meta ==== -->
    <meta name="author" content="ThemeLooks">
    <meta name="description" content="Multipurpose Facebook Network HTML5 Template">
    <meta name="keywords"
          content="Facebook media, Facebook network, forum, shop, bootstrap, html5, css3, template, responsive, retina ready">

    <!-- ==== Favicon ==== -->
    <link rel="icon" href="{% static 'SocialMedia/favicon.png' %}" type="image/png">

    <!-- ==== Google Font ==== -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Raleway:400,500,600,700%7CRoboto:300,400,400i,500,700">

    <link rel="stylesheet" href="{% static 'SocialMedia/css/lightgallery.css' %}">


    <script src="{% static 'SocialMedia/js/lightgallery/lightgallery.min.js' %}"></script>
    <script src="{% static 'SocialMedia/js/lightgallery/lg-thumbnail.js' %}"></script>
    <script src="{% static 'SocialMedia/js/lightgallery/lg-video.js' %}"></script>


    <!-- ==== Plugins Bundle ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/css/plugins.min.css' %}">

    <!-- ==== Main Stylesheet ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/style.css' %}">

    <!-- ==== Responsive Stylesheet ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/css/responsive-style.css' %}">

    <!-- ==== Color Scheme Stylesheet ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/css/colors/color-1.css' %}" id="changeColorScheme">


    <!-- ==== Linkedin Stylesheet ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/css/mur/style1.css' %}" type="text/css"/>
    <link rel="stylesheet" href="{% static 'SocialMedia/css/mur/style2.css' %}" type="text/css"/>

    <!-- ==== Custom Stylesheet ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/css/lightbox.css' %}">

    <!-- ==== Custom Stylesheet ==== -->
    <link rel="stylesheet" href="{% static 'SocialMedia/css/custom.css' %}">



    {% if request.user.is_authenticated %}
        {% include 'pusher_chat_app/chatbox/chatbox_style.html' %}
    {% endif %}



    <!-- ==== HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries ==== -->
    <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->




{% endblock stylesheets %}


{% block menu %}
    {% if user.is_authenticated %}
        <!-- Header Navbar Start -->
        <div class="header--navbar navbar bg-black" data-trigger="sticky"
             style="background-color: rgb(51,51,51);color: grey;padding-bottom: 4px;">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle style--1 collapsed" data-toggle="collapse"
                            data-target="#headerNav">
                        <span class="sr-only">Toggle Navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                    <div class="widget search-menu-little"
                         style="width: 200px;position: absolute;top: 10px;left: 100px;">
                        <!-- Newsletter Widget Start -->
                        <div class="newsletter--widget style--1" data-form="validate">
                            <form action="/reseausocial/search/" name="search-form" novalidate="novalidate">
                                <div class="input-group">

                                    <input type="text" name="keywords" placeholder=" "
                                           class="form-control valid" autocomplete="off" required=""
                                           style="background-color: #565454;color: white;font-weight: 500;"
                                           aria-invalid="false">

                                    <div class=" input-group-addon text-default search-icon-menu"
                                         onclick="javascript:document.forms['search-form'].submit(); "
                                         style="   background-color: transparent;  padding: 0px 0px; border: 0px solid #ccc;">
                                        <button type="submit" class="btn-link"
                                                style="background-color: #565454;/* color: grey; */"><i
                                                class="fa fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!-- Newsletter Widget End -->
                    </div>

                    <!-- Header Navbar Logo Start -->
                    <div class="header--navbar-logo navbar-brand">
                        <a href="{% url 'SocialMedia:home' %}">
                            <h2 class="menu-title" style="width: 40px;height:30px;margin-top: 13px;">
                                {% include 'SocialMedia/svg_btp.html' %}
                            </h2>
                        </a>
                    </div>
                    <!-- Header Navbar Logo End -->
                </div>

                {% if user.is_authenticated %}

                    <div id="headerNav" class="navbar-collapse collapse float--right navbar-menu-custom">


                        <!-- Header Nav Links Start -->
                        <ul class="header--nav-links style--1 nav ff--primary" style="color: #e7e5e5;">
                            <li class="li-search-menu text-center-menu "
                                style="    position: absolute; left: 100px; ">

                                <div class="widget search-menu-grand" style="width:300px;">
                                    <!-- Newsletter Widget Start -->
                                    <div class="newsletter--widget style--1" data-form="validate">
                                        <form action="/reseausocial/search/" name="search-form">
                                            <div class="input-group">
                                                <input type="text" name="keywords" placeholder=" "
                                                       class="form-control valid"
                                                       autocomplete="off" required=""
                                                       style="background-color: #565454;color: white;font-weight: 500;"
                                                       aria-invalid="false">

                                                <div class=" input-group-addon text-default search-icon-menu"
                                                     onclick="javascript:document.forms['search-form'].submit(); "
                                                     style=" background-color: transparent;  padding: 0px 0px; border: 0px solid #ccc;">
                                                    <button type="submit" class="btn-link"
                                                            style="background-color: #565454;/* color: grey; */"><i
                                                            class="fa fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <!-- Newsletter Widget End -->
                                </div>
                                <!-- Widget End -->
                            </li>

                            <li style=" height: 50px;  line-height: 15px;">
                                <a href="{% url 'SocialMedia:home' %}"
                                   class="text-center-menu">
                                    <span style=" font-size: 10px;"><i class="fa fa-home"
                                                                       style=" font-size: 20px;"></i><br>Acceuil</span>
                                </a>
                            </li>

                            {% if user.is_authenticated %}
                                <li style=" height: 50px;  line-height: 15px;margin-top: 3px;">
                                    <a href="{% url 'SocialMedia:myprofil' %}" class="btn-link text-center-menu"
                                       style=" padding-bottom: 0px; padding-top: 8px; ">
                                        <img src="{{ user.profil.photo_profil.image.url }}"
                                             style="width: 25px;    height: 25px;" class="img-circle"><br>
                                        <span style="font-size:10px;">{{ user.first_name | title | default:"User" }} </span>
                                    </a>
                                </li>
                            {% endif %}
                            <li style=" height: 50px;  line-height: 15px;">
                                <a href="{% url 'SocialMedia:reseau' %}" class="text-center-menu">
                                    <span style=" font-size: 10px;"><i class="fa fa-users"
                                                                       style=" font-size: 20px;"></i><br>Réseau</span>
                                </a>

                            </li>
                            <li style=" height: 50px;  line-height: 15px;">
                                <a href="{% url 'SocialMedia:Amis' %}" class="text-center-menu">
                                    <span style=" font-size: 10px;"><i class="fa fa-share-alt"
                                                                       style=" font-size: 20px;"></i><br>Amis</span>
                                </a>

                            </li>
                            <li style=" height: 50px;  line-height: 15px;">
                                <a href="/reseausocial/search_offers/?keywords=all&duree=toutes"
                                   class="text-center-menu">
                                    <span style=" font-size: 10px;"><i class="fa fa-briefcase "
                                                                       style=" font-size: 20px;"></i><br>Offres d'emploi</span>
                                </a>
                            </li>


                            <li style=" height: 50px;  line-height: 15px;">
                                <a href="{% url 'SocialMedia:notifications' %}" class=" text-center-menu">
                                    <span class="nav-item__badge hidden" id="NBnotifications"
                                          style=" border: 1px solid #283e4a; border-radius: 14px; z-index: 1; position: absolute; top: 12px; left: calc(50% + 0px); height: 18px; min-width: 14px; background-color: #cf5000; font-size: 12px; font-weight: 400; color: white; line-height: 18px; text-align: center; padding: 0 4px; "><span
                                            aria-hidden="true" class="nav-item__badge-count"
                                            id="NotificationsCounter">2</span></span>
                                    <span style=" font-size: 10px;"><i class="fa fa-bell "
                                                                       style=" font-size: 20px;"></i><br>Notifications</span>
                                </a>
                            </li>


                        </ul>
                        <!-- Header Nav Links End -->
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Header Navbar End -->

        </header>
        <!-- Header Section End -->
        </div>
    {% endif %}
{% endblock menu %}

{% block banner %}
{% endblock banner %}


{% block content %}

{% endblock content %}

{% block footer %}
    {{ block.super }}
{% endblock footer %}

{% block scripts %}


    {{ block.super }}
    <div id="backToTop">
        <a href="#" class="btn"><i class="fa fa-caret-up"></i></a>
    </div>
    <!-- Back To Top Button End -->

    <!-- ==== Plugins Bundle ==== -->
    <script src="{% static 'SocialMedia/js/plugins.min.js' %}"></script>


    <!-- ==== Main Script ==== -->
    <script src="{% static 'SocialMedia/js/main.js' %}"></script>

    <!-- ==== SweetJs Script ==== -->
    <script src="{% static 'SocialMedia/js/sweetalert2.js' %}"></script>

    <!-- ==== WayPoint Script ==== -->
    <script src="{% static 'SocialMedia/js/jquery.waypoints.min.js' %}"></script>

    <!-- ==== infinite Script ==== -->
    <script src="{% static 'SocialMedia/js/infinite.min.js' %}"></script>



    <!-- ==== Video Js Script ==== -->
    <script src="{% static 'SocialMedia/js/lightbox.js' %}"></script>


    <!-- ==== Custom Script ==== -->
    <script src="{% static 'SocialMedia/js/custom.js' %}"></script>


    <script src="{% static 'SocialMedia/js/comment.js' %}"></script>


    <script>
        lightbox.option({
            'resizeDuration': 100,
            'wrapAround': true
        })
    </script>

    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(
                            cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
    </script>
    <script>
        $("#linkReseauSocial").addClass("active");
        $("#linkReseauSocial1").addClass("active");
        $("#linkReseauSocial2").addClass("active");


        function fixForms() {

            /* Styling Experience SelectDateWidget + autocomplete Field */

            $("#id_date_debut_day").css("display", "none");
            $("#id_date_fin_day").css("display", "none");

            $("#id_date_debut_month").css({"width": "100px"});
            $("#id_date_debut_month").addClass("col-xs-4")
            $("#id_date_debut_year").addClass("col-xs-4")
            $("#id_date_debut_year").css({"width": "100", "margin-left": "15px"});

            $("#id_date_fin_month").css({"width": "100px"});
            $("#id_date_fin_month").addClass("col-xs-4")
            $("#id_date_fin_year").addClass("col-xs-4")
            $("#id_date_fin_year").css({"width": "100", "margin-left": "15px"});

            /* End Styling Experience SelectDateWidget */

            /* Styling Formation SelectDateWidget */

            $("[name=date_debut_day]").css("display", "none");
            $("[name=date_fin_day]").css("display", "none");
            $("[name=annee_fin_day]").css("display", "none");
            $("[name=annee_debut_month]").css("display", "none");
            $("[name=annee_fin_month]").css("display", "none");
            $("[name=annee_debut_day]").css("display", "none");


            $("[name=date_fin_month]").css({"width": "100px"});
            $("[name=date_fin_year]").css({"width": "100", "margin-left": "15px"});
            $("[name=date_fin_month]").addClass("col-xs-4")
            $("[name=date_fin_year]").addClass("col-xs-4")

            $("[name=date_debut_month]").css({"width": "100px"});
            $("[name=date_debut_year]").css({"width": "100", "margin-left": "15px"});
            $("[name=date_debut_month]").addClass("col-xs-4")
            $("[name=date_debut_year]").addClass("col-xs-4")


            $("[name=annee_debut_month]").css({"width": "100px"});
            $("[name=annee_debut_month]").addClass("col-xs-4");
            $("[name=annee_debut_year]").addClass("col-xs-4");
            $("[name=annee_debut_year]").css({"width": "100",});

            $("[name=annee_fin_month]").css({"width": "100px"});
            $("[name=annee_fin_month]").addClass("col-xs-4");
            $("[name=annee_fin_year]").addClass("col-xs-4");
            $("[name=annee_fin_year]").css({"width": "100",});

            $("[name=date_naissance_day]").css({"width": "100px"});
            $("[name=date_naissance_month]").css({"width": "100px"});
            $("[name=date_naissance_year]").css({"width": "100px"});
            $("[name=date_naissance_month]").css({"width": "100", "margin-left": "15px"});
            $("[name=date_naissance_year]").css({"width": "100", "margin-left": "15px"});
            $("[name=date_naissance_day]").addClass("col-xs-4");
            $("[name=date_naissance_month]").addClass("col-xs-4");
            $("[name=date_naissance_year]").addClass("col-xs-4");

            /* End Styling Formation SelectDateWidget */

            /* Suggestions Fields */
            $('.ecole_suggestion').attr("data-list", "{{ nom_ecoles }}")
            $('.poste_suggestion').attr("data-list", "{{ nom_postes }}")
            $('.entreprise_suggestion').attr("data-list", "{{ nom_entreprises }}")
            $('.organisme_suggestion').attr("data-list", "{{ nom_organismes }}")
            /* End Suggestion Fields */
        }

        $("#coverpic")
            .mouseover(function () {
                $('button.btchangepic').css("background-color", "#333")
                $('button.btchangepic').css("border", "1px solid white")
                $('button.btchangepic').css("opacity", "0.9")
                $('button.btchangepic').html("<i class=\"fa fa-camera\" aria-hidden=\"true\"></i> Actualiser la photo de couverture")
            })
            .mouseout(function () {
                $('button.btchangepic').css("background-color", "transparent")
                $('button.btchangepic').css("border", "0px solid white")
                $('button.btchangepic').html('<i class="fa fa-camera" aria-hidden="true"></i>', "")
            });


        $("#btcoverchange")
            .mouseover(function () {
                $('button.btchangepic').css("background-color", "#333")
                $('button.btchangepic').css("border", "1px solid white")
                $('button.btchangepic').css("opacity", "0.9")
                $('button.btchangepic').html("<i class=\"fa fa-camera\" aria-hidden=\"true\"></i> Actualiser la photo de couverture")
            })
            .mouseout(function () {
                $('button.btchangepic').css("background-color", "transparent")
                $('button.btchangepic').html('<i class="fa fa-camera" aria-hidden="true"></i>', "")
            });


    </script>

    <script>
        function click_header(header) {

            var data_id = ($(header).closest("div").attr('data-id'));
            data_id = data_id.substr(data_id.lastIndexOf('-'), data_id.length);

            $('div[data-id="chat' + data_id + '"]').slideToggle(300, 'swing');
            $('span[data-id="chat-message-counter' + data_id + '"]').fadeTo(300, 'swing');

        };

        function chat_close(element) {

            var data_id = ($(element).closest("div").attr('data-id'));
            data_id = data_id.substr(data_id.lastIndexOf('-'), data_id.length);

            $('div[data-id="live-chat' + data_id + '"]').fadeOut(300);

        }


        $(document).ready(function () {
            /* Pour Reduire les fenetre automatiquement, semble marcher sans ce code...
            var n = 0;
            for (i = -1; i < n; i++) {
                $('div[data-id="chat-' + n + '"]').hide();

                console.log(n)
                if (!($('div[data-id="chat-' + (n + 1) + '"]').attr("data-id") === undefined)) {
                    n++;
                }
            }
               */
            // Scroll commence toujours en bas pour les messages
            //var messageBody = document.querySelector('.chat-history');
            //messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
        });

        {% comment %}
        Chat Socket program
        $(document).ready(function () {

            $(window).bind('beforeunload',function()
            {
                $.ajax({
                    type: 'GET',
                    async:false,
                    url:'/reseausocial/deconnecter/'
                });
            });

            //Connexion
            chatSocket = new WebSocket(
                'ws://' + window.location.host +
                '/ws/chat_pro/connect/');

            chatSocket.onclose = function (e) {
                console.error('Chat socket closed unexpectedly');
            };

            //Recevoir message
            chatSocket.onmessage = function (e) {

                console.log("send enter");
                var data = JSON.parse(e.data);
                var message_type = data["message_type"];
                var message = data['message'];

                if (message_type === "new_message") {
                    sender = data["user_sender"];
                    user_to_send = data['user_to_send'];

                    $('div[data-id="live-chat-' + user_to_send + '"]').find("#chat-history-" + user_to_send + " .infinite-container").append(message);

                    if (sender != mid) {

                        notification.play();

                        if ($('#live-chat-container').children('div[data-id="live-chat-' + sender + '"]').length === 0) {
                            open_chat(div = null, user_id = mid, data_id = sayeb_chat_name(mid, sender), other_user_id = sender);
                        }
                        else {
                            if ($('#live-chat-container').find('div[data-id="live-chat-' + sender + '"]').css("display") === "none") {
                                $('#live-chat-container').find('div[data-id="live-chat-' + sender + '"]').css("display", "block");
                                $('#live-chat-container').find('div[data-id="chat-' + sender + '"]').css("display", "none");

                                //Scroll en bas des msg
                                var user_chat = +sender;
                                var messageBody = document.querySelector('#chat-history-' + sender);
                                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                            }
                        }

                        chat_name = sayeb_chat_name(user_to_send, mid);
                        nb_messages = 0;
                        //Messages non lu
                        $.ajax({

                            url: "/chat/nb_msg_nonlu/" + chat_name + "/",
                            type: 'GET',
                            async: false,

                            success: function (response) {
                                nb_messages = response;
                            },

                            error: function (response) {
                                nb_messages = -1;
                            },

                            complete: function (response) {
                                console.log("comlpete")
                            },

                        });

                        $("div[data-id='live-chat-" + user_to_send + "'] .chat-message-counter").html(nb_messages);
                    }

                    var messageBody = document.querySelector('#chat-history-' + user_to_send);
                    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                    // 7it mal9ach messageBody makikemelch lcode

                    verifier_nb_messages("div[data-id='live-chat-" + user_to_send + "'] .chat-message-counter");
                }
                if (message_type === "connection_notification") {
                    chat = sayeb_chat_name(mid, data["user_to_send"]);

                    if ($('#chat-messagerie').children('div[data-id="' + chat + '"]').length === 0) {
                        $("#chat-messagerie").append(data["user_connected"]);

                    }
                    else {
                        console.log("kayen")
                    }
                }
                if (message_type === "response_connection_notification") {
                    chat = sayeb_chat_name(mid, data["user_to_send"]);

                    if ($('#chat-messagerie').children('div[data-id="' + chat + '"]').length === 0) {
                        $("#chat-messagerie").append(data["user_connected"]);
                    }
                }
                if (message_type === "deconnection_notification") {
                    chat = sayeb_chat_name(mid, data["user_to_disconnect"]);

                    console.log("deconecta"+ chat)
                    console.log("mid = " +mid)
                    console.log("user to disconect : " + data["user_to_disconnect"])
                    if ($('#chat-messagerie').children('div[data-id="' + chat + '"]').length !== 0) {
                        $('#chat-messagerie').children('div[data-id="' + chat + '"]').remove();
                    }
                }

                /*
                // Scroll commence toujours en bas pour les messages
                var messageBody = document.querySelector('#chat-history-1');
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                */
            };

        });


        // Click sur un user dans la messagerie : ouvre une fenetre de chat de ce user
        function open_chat(div = null, user_id = -1, data_id = -1, other_user_id = -1) {

            if (data_id == -1) {
                data_id = data_id;
            }

            if (user_id == -1) {
                user_id = mid;
            }

            if (other_user_id == -1) {
                other_user_id = $(div).attr("user-chat");
            }
            username = "";
            if (div == null && user_id != -1) {
                $.ajax({

                    url: "/chat/get_username/" + user_id + "/",
                    type: 'GET',
                    async: false,

                    success: function (response) {
                        username = response;
                    },

                    error: function (response) {
                        username = "unknown"
                    },

                    complete: function (response) {
                        console.log("comlpete")
                    },

                });
            }
            else {
                username = $(div).find("h5").text();
            }


            if ($('#live-chat-container').find('div[data-id="live-chat-' + other_user_id + '"]').css("display") === "none") {
                $('#live-chat-container').find('div[data-id="live-chat-' + other_user_id + '"]').css("display", "block");
                $('#live-chat-container').find('div[data-id="chat-' + other_user_id + '"]').css("display", "block");

                //Scroll en bas des msg
                var user_chat = +other_user_id;
                var messageBody = document.querySelector('#chat-history-' + user_chat);
                messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                var user_chat = other_user_id;
                $('body').find('#live-chat-' + user_chat + '-envoyer').focus();
            }
            else {
                room_name = "";
                if (user_id >= other_user_id)
                    room_name = user_id + '_' + other_user_id;
                else
                    room_name = other_user_id + "_" + user_id;


                if ($('#live-chat-container').find('div[data-id="live-chat-' + other_user_id + '"]').length === 0) {
                    var my_url = "/chat/get_conversation/chat_" + room_name + "/1/";
                    myconversation = "";
                    $.ajax({

                        url: my_url,
                        type: 'GET',
                        async: false,

                        success: function (response) {
                            console.log("success")
                            myconversation = response;
                        },

                        error: function (response) {
                            window.open(response.responseText)
                            var w = window.open();
                            var html = response.responseText;

                            $(w.document.body).html(html);

                            $(openWindow).html(callScriptText);
                            console.log("erreur")
                        },

                        complete: function (response) {
                            console.log("comlpete")
                        },

                    });

                    // add to #live-chat-container

                        var chat_window = '' +
                        '<div id="live-chat" data-id="live-chat-' + other_user_id + '">\n' +
                        '\n' +
                        '        <header style="padding: 0px 13px;" class="clearfix" id="5" style="z-index:99;" onclick="click_header(this);">\n' +
                        '\n' +
                        '            <a style="margin-top: 16px;" href="#" class="chat-close" data-id="chat-close-' + other_user_id + '" onclick="chat_close(this);">x</a>\n' +
                        '\n' +
                        '            <h4 style="color: white;">\n' +
                        '                ' + username + '\n' +
                        '                <span class="chat-message-counter" data-id="chat-message-counter-' + other_user_id + '">0</span>\n' +
                        '            </h4>\n' +
                        '\n' +
                        '        </header>\n' +
                        '\n' +
                        '\n' +
                        '        <div class="chat" data-id="chat-' + other_user_id + '" style="display:block;">\n' +
                        '\n' +
                        '            <div onscroll="scroll_chat(this);" class="chat-history" id="chat-history-' + other_user_id + '">\n' +
                        '    ' + myconversation + ' \n' +
                        '\n' +
                        '        </div> <!-- end chat -->\n' +

                        '            </div> <!-- end chat-history -->\n' +
                        '            <input style="border:none;border-top: 1px solid whitesmoke;"  type="text" placeholder="Ecrivez votre message" autofocus id="live-chat-' + other_user_id + '-envoyer"\n' +
                        '                   autocomplete="off" data-id="' + other_user_id + '">\n' +
                        '            <input onkeyup="envoyer_message_submit(this);" type="hidden" id="live-chat-' + other_user_id + '-submit">\n' +
                        '\n' +
                        '    </div>';







                    chat_name = sayeb_chat_name(other_user_id, mid);


                    $('#live-chat-container').append(chat_window);

                    // S'il click sur la conversation il met : Vu à tout les msgs
                    $('#chat-history-' + other_user_id).click(function () {
                        $.ajax({

                            url: "/chat/lire_msg/" + chat_name + "/",
                            type: 'GET',
                            async: false,

                            success: function (response) {
                                nb_messages = response;
                            },

                            error: function (response) {
                            },

                            complete: function (response) {
                                console.log("comlpete")
                            },
                        });

                        $("div[data-id='live-chat-" + other_user_id + "'] .chat-message-counter").html(0);
                        verifier_nb_messages("div[data-id='live-chat-" + other_user_id + "'] .chat-message-counter");
                    });

                    //focus sur l'input text
                    // + Evenement click entrer = submit
                    document.querySelector('#live-chat-' + other_user_id + '-envoyer').focus();
                    document.querySelector('#live-chat-' + other_user_id + '-envoyer').onkeyup = function (e) {
                        if (e.keyCode === 13) {  // enter, return
                            document.querySelector('#live-chat-' + other_user_id + '-submit').click();
                        }
                    };

                    //Envoi message
                    document.querySelector('#live-chat-' + other_user_id + '-submit').onclick = function (e) {
                        var messageInputDom = document.querySelector('#live-chat-' + other_user_id + '-envoyer');
                        var message = messageInputDom.value;

                        chatSocket.send(JSON.stringify({
                            'message': message,
                            'room_name': room_name
                        }));

                        messageInputDom.value = '';
                    };
                }
                else {
                    $('#live-chat-container').find('div[data-id="chat-' + other_user_id + '"]').css("display", "block");
                    //Scroll en bas des msg
                    var user_chat = +other_user_id;
                    var messageBody = document.querySelector('#chat-history-' + user_chat);
                    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
                    document.querySelector('#live-chat-' + user_chat + '-envoyer').focus();
                }
            }

            verifier_nb_messages("div[data-id='live-chat-" + other_user_id + "'] .chat-message-counter");

        }



        function scroll_chat(div) {
            if ($(div).scrollTop() === 0) {

                if ($($(div).find('.infinite-more-link')[0]).attr("href") !== undefined) {
                    my_url = "/chat/" + $($(div).find('.infinite-more-link')[0]).attr("href");

                    $.ajax({

                        url: my_url,
                        type: 'GET',
                        async: false,

                        success: function (response) {
                            console.log("success");
                            height = $(div)[0].scrollHeight;
                            $($(div).find('.infinite-more-link')[0]).remove();
                            $(div).prepend(response);
                            $(div)[0].scrollBy(0, 280);
                        },

                        error: function (response) {
                            window.open(response.responseText)
                            var w = window.open();
                            var html = response.responseText;

                            $(w.document.body).html(html);

                            $(openWindow).html(callScriptText);
                            console.log("erreur")
                        },

                        complete: function (response) {
                            console.log("comlpete")
                        },
                    });
                }

                /*
            if($(div).scrollTop()) {
                $('body').find('.infinite-more-link').click();
                //$( 'live-chat-'+other_user_id).find(".infinite-more-link").click ();
                $(div).trigger('resize')

                alert ("scroll height: "+$(div)[0].scrollHeight+" scrolltop "+ $(div).scrollTop()+" outer height : "+ $(div).outerHeight() )
            }
            */
            }
        }

        function sayeb_chat_name(id1, id2) {
            id1 = parseInt(id1);
            id2 = parseInt(id2);

            chat_name = "chat_";
            if (id1 >= id2) {
                chat_name += id1 + "_" + id2;
            }
            else {
                chat_name += id2 + "_" + id1;
            }

            return chat_name
        }

        function verifier_nb_messages(div) {
            if ($(div).html() == 0) {
                $(div + ".chat-message-counter").css("display", "none");
            }
            else {
                $(div + ".chat-message-counter").css("display", "inline-block");
            }
        }
        {% endcomment %}


        function checkNotifications() {
            friendURL = "{% url 'SocialMedia:checkNotifications' %}";
            $.ajax({
                url: friendURL,
                type: 'GET',
                success: function (data) {
                    if (data.nbNotifications == "0") {
                        $("#NBnotifications").addClass("hidden");
                    } else {
                        $("#NBnotifications").removeClass("hidden");
                        $("#NotificationsCounter").html(data.nbNotifications);
                    }
                },
                error: function () {
                },
                complete: function () {

                },
                stop: function (e) {
                }
            });
        };


        //setInterval(function(){ checkNotifications(); }, 15000);


    </script>


    {% if request.user.is_authenticated %}
        {% include  'pusher_chat_app/chatbox/chatbox.html' %}
    {% endif %}


{% endblock scripts %}
