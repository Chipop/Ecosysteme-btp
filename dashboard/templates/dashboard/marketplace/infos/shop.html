{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    Boutique | Ecommerce | {{ block.super }}
{% endblock title %}

{% block stylesheets %}

    {{ block.super }}

    <!-- c3 Charts -->
    <link href="{% static 'dashboard/css/plugins/c3/c3.min.css' %}" rel="stylesheet">



{% endblock stylesheets %}


{% block content %}

    <div class="wrapper wrapper-content animated fadeInRight" style="width:100%;">

        <div class="row">
            <div class="col-lg-12">

                <div class=" float-left">
                    <a href="{% url 'dashboard:marketplace_shops' %}">
                        <button class="btn btn-primary dim">
                            <i class="fa fa-arrow-left"></i> Liste des boutiques
                        </button>
                    </a>
                </div>

                <div class=" float-right">
                    <a href="{% url 'dashboard:delete_shop' id_shop=boutique.id %}">
                        <button id="btn_lancer_compagne" class="btn btn-danger dim">
                            <i class="fa fa-trash"></i> Supprimer
                        </button>
                    </a>

                    <a href="{% url 'dashboard:update_shop' id_shop=boutique.id %}">
                        <button class="btn btn-success dim"><i class="fa fa-pencil"></i> Modifier</button>
                    </a>

                </div>
            </div>

        </div>

        <div class="row">

            <div class="col-lg-6">
                <div class="widget style1 navy-bg">
                    <div class="row">
                        <div class="col-4">
                            <i class="fa fa-money fa-5x"></i>
                        </div>
                        <div class="col-8 text-right">
                            <span>Total vendu</span>
                            <h2 class="font-bold">{% if total %}{{ total | intcomma }}{% else %}0{% endif %} DH</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="widget style1 navy-bg">
                    <div class="row">
                        <div class="col-4">
                            <i class="fa fa-eye fa-5x"></i>
                        </div>
                        <div class="col-8 text-right">
                            <span>Vues</span>
                            <h2 class="font-bold">{{ boutique.number_visitors }}</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="widget style1 navy-bg">
                    <div class="row">
                        <div class="col-4">
                            <i class="fa fa-product-hunt fa-5x"></i>
                        </div>
                        <div class="col-8 text-right">
                            <span>Produits</span>
                            <h2 class="font-bold">{{ boutique.product_set.all.count }}</h2>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <div class="row">
            <div class="col-lg-12">
                <div style="background-image:url('{% if boutique.image_cover %}{{ boutique.image_cover.url }}{% else %}{% static "dashboard/img/default_cover.jpg" %} {% endif %}');height:150px;">

                </div>

                <div class="col-lg-12 text-center" style="margin-top:-100px;">
                    <img height="150" width="150"
                         src="{% if boutique.image_profile %} {{ boutique.image_profile.url }} {% else %} {% static 'dashboard/img/default_profil_m.png' %} {% endif %}"
                         class="rounded-circle circle-border m-b-md"
                         alt="profile">
                </div>


            </div>

        </div>
        <div class="row m-b-lg m-t-lg">

            <div class="col-md-4">
                <div style="margin-left:15px;">
                    <div class="">
                        <div><h2 class="no-margins">
                            {{ boutique.name }}
                        </h2>
                            <strong>Propriétaire :</strong> <a
                                    href="">{{ boutique.owner.user.first_name | title }} {{ boutique.owner.user.last_name | title }}</a>
                            <br>
                            <strong>Date création :</strong> {{ boutique.date_creation }} <br>
                            <strong>Nombre de Produits :</strong> {{ boutique.product_set.all.count }} <br>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-md-5">
                <div style="margin-left:15px;">
                    <h2 class="no-margins">
                        Sécteurs d'activité
                    </h2>
                    {% for cat in boutique.categories.all|slice:"3" %}
                        <strong>{{ cat.name }}</strong><br>
                    {% endfor %}
                    <strong><a href="" data-toggle="modal" data-target="#myModal">Voir tout</a></strong>
                </div>
            </div>

            <div class="col-md-3">
                <h2 class="no-margins">Contact </h2>
                <strong>Adresse :</strong> {{ boutique.address }} <br>
                <strong>Téléphone :</strong> {{ boutique.tel }} <br>
            </div>


        </div>

        <div class="row">

            <div class="col-lg-6">
                <div class="ibox ">
                    <div class="ibox-title">
                        <h5>Ventes ces derniers mois en DH</h5>
                    </div>
                    <div class="ibox-content">
                        <div id="morris-line-chart">

                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="ibox ">
                    <div class="ibox-title">
                        <h5>Produits les plus vendus</h5>
                    </div>

                    <div class="ibox-content">
                        <div>
                            <div id="pie" style="width:100%; height: 348px;"></div>
                        </div>

                    </div>
                </div>
            </div>


        </div>


        <div class="row">

            <div class="col-lg-12">
                <div class="ibox ">
                    <div class="ibox-title">
                        <h5>Visites </h5>
                    </div>
                    <div class="ibox-content">
                        <div id="visites-totales-chart-container"></div>
                        <div id="visites-totales-view-selector-container" style="display:none;"></div>
                    </div>
                </div>
            </div>

        </div>

    <div class="row">
            <div class="col-md-12 mar-b-30">
                <div class="list-group">
                    <a href="{% url 'dashboard:tracking_visites' %}?url={{ boutique.tracking_get_absolute_url }}"
                       class="list-group-item list-group-item-action active disabled">
                        Derniers visites <span class="pull-right">Voir tout</span>
                    </a>

                    <table class="table table-striped table-bordered">
                        <thead>
                        <th>Utilisateur</th>
                        <th>Date</th>
                        </thead>

                        <tbody>
                    {% for tracking in tracking_dernieres_visites %}
                        <tr>
                            <td>{% if not tracking.user %} Visiteur non connecté {% else %}
                                <a href="{% url 'dashboard:user_infos' id_user=tracking.user.profil.id %}">{{ tracking.user.first_name|title }} {{ tracking.user.last_name|title }}</a>{% endif %}
                            </td>
                            <td>{{ tracking.timestamp }}</td>
                        </tr>
                    {% empty %}
                            <tr>
                                <td valign="top" colspan="2" class="dataTables_empty text-center">Aucun élément à afficher</td>
                            </tr>
                    {% endfor %}

                        </tbody>

                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">

                <div class="ibox">
                    <div class="ibox-title">
                        <h5>Produits les plus vus </h5>
                        <h5 class="float-right"><a
                                href="{% url 'dashboard:marketplace_products' %}?shop={{ boutique.name }}">Voir tout</a>
                        </h5>
                    </div>


                    <div class="ibox-content">

                        <div class="row">

                            {% for product in produits_plus_vus %}
                                <div class="col-md-3">
                                    <div class="ibox">
                                        <div class="ibox-content product-box">

                                            <div class="">
                                                <img src="{{ product.image.url }}" alt="" width="206" height="199">
                                            </div>

                                            <div class="product-desc">

                                                <span class="product-price">
                                                    {{ product.price | intcomma }} DH
                                                </span>

                                                <small class="text-muted">{{ product.cat.name|truncatechars:"32" }}</small>
                                                <a href="{% url 'dashboard:marketplace_product' id_product=product.id %}"
                                                   class="product-name"> {{ product.name }}</a>

                                                <div class="small m-t-xs">
                                                    <i class="fa fa-eye"></i> {{ product.number_views }}
                                                </div>
                                                <div class="m-t text-righ">

                                                    <a href="{% url 'dashboard:marketplace_product' id_product=product.id %}"
                                                       class="btn btn-xs btn-outline btn-primary">Détails... <i
                                                            class="fa fa-long-arrow-right"></i> </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            {% empty %}
                                <span style="padding-left: 15px;">Aucun Produit.</span>
                            {% endfor %}

                        </div>

                    </div>

                </div>
            </div>
        </div>

        <div class="row">

            <div class="col-lg-12">

                <div class="ibox">
                    <div class="ibox-title">
                        <h5>Tous les produits </h5>
                        <h5 class="float-right"><a
                                href="{% url 'dashboard:marketplace_products' %}?shop={{ boutique.name }}">Voir tout</a>
                        </h5>
                    </div>


                    <div class="ibox-content">

                        <div class="row">

                            {% for product in boutique.product_set.all.reverse %}
                                <div class="col-md-3">
                                    <div class="ibox">
                                        <div class="ibox-content product-box">

                                            <div class="">
                                                <img src="{{ product.image.url }}" alt="" width="206" height="199">
                                            </div>

                                            <div class="product-desc">

                                                <span class="product-price">
                                                    {{ product.price | intcomma }} DH
                                                </span>

                                                <small class="text-muted">{{ product.cat.name|truncatechars:"32" }}</small>
                                                <a href="{% url 'dashboard:marketplace_product' id_product=product.id %}"
                                                   class="product-name"> {{ product.name }}</a>

                                                <div class="small m-t-xs">
                                                    <i class="fa fa-eye"></i> {{ product.number_views }}
                                                </div>

                                                <div class="small m-t-xs">
                                                    {{ product.content|safe|truncatechars:"95" }}
                                                </div>
                                                <div class="m-t text-righ">

                                                    <a href="{% url 'dashboard:marketplace_product' id_product=product.id %}"
                                                       class="btn btn-xs btn-outline btn-primary">Détails... <i
                                                            class="fa fa-long-arrow-right"></i> </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <span style="padding-left: 15px;">Aucun Produit.</span>
                            {% endfor %}

                        </div>

                    </div>

                </div>
            </div>


        </div>


    </div>



    <!-- The Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Secteurs d'activité</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    {% for cat in boutique.categories.all %}
                        <strong>{{ cat.name }}</strong><br>
                    {% endfor %}
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Fermer</button>
                </div>

            </div>
        </div>
    </div>




{% endblock content %}

{% block scripts %}

    {{ block.super }}
    <script>
        $('#dashboard_marketplace').addClass("active");
        $('#marketplace_shops').addClass("active");
    </script>


    <script>
        $(function () {

            // Moris Data
            Morris.Line({
                element: 'morris-line-chart',
                data: [
                    {% for vente in ventes %}
                        {# for i in range(12) si vente.month == 1 and not exists print 0 #}
                        {months: '{{ vente.month }}', a: '{{vente.total_ventes}}'},
                    {% empty %}
                        {months: '1', a: '0'},
                        {months: '2', a: '0'},
                        {months: '3', a: '0'},
                        {months: '4', a: '0'},
                        {months: '6', a: '0'},
                        {months: '7', a: '0'},
                        {months: '8', a: '0'},
                        {months: '9', a: '0'},
                        {months: '10', a: '0'},
                        {months: '11', a: '0'},
                        {months: '12', a: '0'},
                    {% endfor %}
                ],
                xkey: 'months',
                ykeys: ['a'],
                labels: ['Ventes'],
                hideHover: 'auto',
                resize: true,
                lineColors: ['#54cdb4'],
                parseTime: false,
                xLabelFormat: function (x) {
                    return 'Mois ' + x.label
                }
            });

        });

    </script>


    <!-- d3 and c3 charts -->
    <script src="{% static 'dashboard/js/plugins/d3/d3.min.js' %}"></script>
    <script src="{% static 'dashboard/js/plugins/c3/c3.min.js' %}"></script>




    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script>
        //Handles differences in load functions
        google.load = google.load || google.charts.load;
        google.setOnLoadCallback = google.setOnLoadCallback || google.charts.setOnLoadCallback;

        //Loads the google analytics API
        (function (w, d, s, g, js, fs) {
            g = w.gapi || (w.gapi = {});
            g.analytics = {
                q: [], ready: function (f) {
                    this.q.push(f);
                }
            };
            js = d.createElement(s);
            fs = d.getElementsByTagName(s)[0];
            js.src = 'https://apis.google.com/js/platform.js';
            fs.parentNode.insertBefore(js, fs);
            js.onload = function () {
                g.load('analytics');
            };
        }(window, document, 'script'));

        //Load the charts you want
        google.charts.load('current', {packages: ['corechart', 'line' /* 'table', 'geochart', */]})
    </script>


    <script type="text/javascript">
        google.charts.load('current', {'packages': ['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {

            var data = google.visualization.arrayToDataTable([
                ['Nom du produit', 'Prix en DH'],
                {% for pr in ventes_pie %}
                    ['{{ pr.nom_produit }}', {{ pr.total| stringformat:'d' }}],
                {% empty %}
                    ['Aucun', 1],
                {% endfor %}
            ]);

            var options = {
                title: 'Ventes  en DH'
            };

            var chart = new google.visualization.PieChart(document.getElementById('pie'));

            chart.draw(data, options);
        }
    </script>



    <script>

        //Visites totales Line Chart Ecommerce


        gapi.analytics.ready(function () {

            /**
             * Authorize the user with an access token obtained server side.
             */
            gapi.analytics.auth.authorize({
                'serverAuth': {
                    'access_token': '{{ ACCESS_TOKEN_FROM_GOOGLE_SERVICE_ACCOUNT }}'
                }
            });

            /**
             * Create a new DataChart instance with the given query parameters
             * and Google chart options. It will be rendered inside an element
             * with the id "chart-container".
             */


            var dataChart = new gapi.analytics.googleCharts.DataChart({
                query: {
                    metrics: 'ga:pageviews,ga:uniquePageViews',
                    dimensions: 'ga:date',
                    'start-date': '183daysAgo',
                    'end-date': 'today',
                    filters: 'ga:pagePath=@/e_commerce/supplier/{{ boutique.id }}/',
                },
                chart: {
                    container: 'visites-totales-chart-container',
                    type: 'LINE',
                    options: {
                        width: '100%'
                    }
                }
            });

            /**
             * Render the dataChart on the page.
             */
            dataChart.set({query: {ids: "ga:181212196"}}).execute();


        });
    </script>







{% endblock scripts %}

