{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load humanize %}
{% load dashboard_tags %}

{% block title %}
    Liste des visites | Tracking | {{ block.super }}
{% endblock title %}

{% block stylesheets %}

    {{ block.super }}
    <!-- Sweet Alert -->
    <link href="{% static 'dashboard/css/plugins/sweetalert/sweetalert.css' %}" rel="stylesheet">
    <!-- Toastr style -->
    <link href="{% static 'dashboard/css/plugins/toastr/toastr.min.css' %}" rel="stylesheet">
    <link href="{% static 'dashboard/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css' %}"
          rel="stylesheet">




{% endblock stylesheets %}


{% block content %}

    <div class="wrapper wrapper-content wrapper-content-custom">


        <div class="row">


            <div id="window_liste_emails" class="col-lg-12 animated fadeInRight">
                <div class="mail-box-header">

                    <h2>
                        Visites
                    </h2>

                    <div class="mail-tools tooltip-demo m-t-md">


                    </div>
                </div>
                <div class="mail-box">

                    <div class="col-lg-12" >
                        <div class="row btn-group">




                                <div style="margin-bottom:5px;"  class="col-md-1">
                                     <span style=" font-size: 15px;    font-weight: 600;">Filtres: </span>
                                </div>
                                <div style="margin-bottom:5px;" class="col-md-2">

                                    <select name="" id="filter_type" class="form-control"
                                            >
                                        <option value="tout">Tout</option>

                                        <optgroup label="Journal">
                                            <option value="Journaliste">Journalistes</option>
                                            <option value="Article">Articles</option>
                                            <option value="Article Vidéo">Articles vidéo</option>
                                            <option value="Catégorie Articles">Catégories</option>
                                        </optgroup>

                                        <optgroup label="E-Commerce">
                                            <option value="Boutique">Boutiques</option>
                                            <option value="Produit">Produits</option>
                                            <option value="Marque">Marques</option>
                                            <option value="Tag">Tags</option>
                                        </optgroup>

                                        <optgroup label="Q&A">
                                            <option value="Question">Questions</option>
                                            <option value="QA Article">Articles</option>
                                            <option value="QA Catégorie">Catégories</option>
                                            <option value="QA Tag">Tags</option>
                                        </optgroup>

                                        <optgroup label="Réseau social">
                                            <option value="Groupe">Groupe</option>
                                            <option value="Page Entreprise">Page Entreprise</option>
                                            <option value="Offre d'emploi">Offre d'emploi</option>
                                            <option value="Statut">Statut</option>
                                            <option value="Statut partagé">Statut partagé</option>
                                        </optgroup>

                                        <optgroup label="Appel d'offres">
                                            <option value="Appel d'offre">Appels d'offres</option>
                                            <option value="Lot">Lots</option>
                                        </optgroup>

                                    </select>
                                </div>

                                <div style="margin-bottom:5px;" class="col-md-2">
                                    <input id="filter_url" type="text" class="form-control" placeholder="Url exacte"
                                       style="">
                                </div>

                                <div style="margin-bottom:15px;" class="col-md-1">
                                    <div class="checkbox checkbox-success" >
                                    <input type="checkbox" id="check_date" name="example1">
                                    <label class="" for="check_date" style="">Date</label>
                                </div>
                                </div>

                                <div style="margin-bottom:5px;" class="col-md-2">
                                    <div id="reportrange"
                                     style="background: #fff; cursor: pointer; padding: 5px 5px; border: 1px solid #ccc;  ">
                                    <i class="fa fa-calendar"></i>&nbsp;
                                    <span></span> <i class="fa fa-caret-down"></i>
                                </div>
                                </div>

                                <div style="margin-bottom:5px;" class="col-md-2">
                                    <input id="filtrer_email" type="email" class="form-control" placeholder="Email exact"
                                       >
                                </div>


                                <div style="margin-bottom:5px;" class="col-md-1">
                                    <button class="btn btn-primary" onclick="filter_visits();">
                                    Filtrer
                                </button>
                                </div>
                            </div>


                        </div>
                    </div>


                    <table id="example" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                        <tr>
                            <th>Visiteur</th>
                            <th>Page</th>
                            <th>Url</th>
                            <th>Date visite</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for tracking in tracking_list %}
                            <tr>
                                <td>
                                    {% if not tracking.user %}
                                        Visiteur non connecté
                                    {% else %}
                                        <a href="{% url 'dashboard:user_infos' id_user=tracking.user.profil.id %}">{{ tracking.user.first_name|title }} {{ tracking.user.last_name|title }}</a>
                                    {% endif %}
                                </td>
                                <td>{% if tracking.content_object %}
                                    {{ tracking.content_object |verbose_name }}{% endif %} :
                                    {% if  tracking.content_object.tracking_get_admin_url != "" %}
                                        <a href="{{ tracking.content_object.tracking_get_admin_url }}">{% endif %}{{ tracking.content_object.tracking_get_description }}
                                    {% if tracking.content_object.tracking_get_admin_url != "" %}</a>{% endif %}
                                </td>
                                <td>{{ tracking.content_object.tracking_get_absolute_url }}</td>
                                <td>{{ tracking.timestamp }}</td>
                                <td>
                                    <a href="{{ tracking.content_object.tracking_get_absolute_url }}" target="_blank">
                                        <button class="btn btn-success btn-xs">Visiter</button>
                                    </a>

                                    <a href="{% url 'dashboard:tracking_visite' id_visite=tracking.id %}">
                                        <button class="btn btn-primary btn-xs">Voir plus</button>
                                    </a>

                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td valign="top" colspan="5" class="dataTables_empty text-center">Aucun élément à
                                    afficher
                                </td>
                            </tr>
                        {% endfor %}

                        </tbody>
                    </table>

                    <div class="dataTables_paginate paging_full_numbers pull-right" id="example_paginate">
                        <ul class="pagination">
                            <li class="paginate_button page-item first {% if not tracking_list.has_previous %} disabled {% endif %}"
                                id="example_first">
                                <a href="



                                        {% if tracking_list.has_previous %}{% url "dashboard:tracking_visites" %}?{% url_replace request 'page' 1 %}{% endif %}"
                                   class="page-link">«</a>
                            </li>
                            <li class="paginate_button page-item previous  {% if not tracking_list.has_previous %} disabled {% endif %}"
                                id="example_previous">
                                <a href="



                                        {% if tracking_list.has_previous %}{% url "dashboard:tracking_visites" %}?{% url_replace request 'page' tracking_list.previous_page_number %}{% endif %}"
                                   class="page-link">‹</a>
                            </li>


                            {% for i in tracking_list.paginator.page_range %}
                                {% if tracking_list.number == i %}
                                    <li class="paginate_button page-item active">
                                        <a href="#" class="page-link">{{ i }}</a>
                                    </li>
                                {% elif i > tracking_list.number|add:'-5' and i < tracking_list.number|add:'5' %}

                                    <li class="paginate_button page-item">
                                        <a href="{% url "dashboard:tracking_visites" %}?{% url_replace request 'page' i %}"
                                           class="page-link">{{ i }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <li class="paginate_button page-item next {% if not tracking_list.has_next %} disabled {% endif %}"
                                id="example_next">
                                <a href="



                                        {% if tracking_list.has_next %}{% url "dashboard:tracking_visites" %}?{% url_replace request 'page' tracking_list.next_page_number %}{% endif %}"
                                   tabindex="0" class="page-link">›</a>
                            </li>
                            <li class="paginate_button page-item last {% if not tracking_list.has_next %} disabled {% endif %}"
                                id="example_last">
                                <a href="



                                        {% if tracking_list.has_next %}{% url "dashboard:tracking_visites" %}?{% url_replace request 'page' tracking_list.paginator.num_pages %}{% endif %}"
                                   class="page-link">»</a>
                            </li>
                        </ul>
                    </div>

                    <div class="clearfix">

                    </div>


                </div>
            </div>


        </div>
    </div>






{% endblock content %}

{% block scripts %}

    {{ block.super }}
    <script>
        $('#dashboard_tracking_visites').addClass("active");
    </script>


    <!-- Data picker -->
    <script src="{% static 'dashboard/js/plugins/datapicker/bootstrap-datepicker.js' %}"></script>

    <!-- Date range use moment.js same as full calendar plugin -->
    <script src="{% static 'dashboard/js/plugins/fullcalendar/moment.min.js' %}"></script>

    <!-- Date range picker -->
    <script src="{% static 'dashboard/js/plugins/daterangepicker/daterangepicker.js' %}"></script>


    <!-- Sweet alert -->
    <script src="{% static 'dashboard/js/plugins/sweetalert/sweetalert.min.js' %}"></script>


    <script>

        //Date Range Config + Initialisation


        var start_date = moment().subtract(365, 'days').format('YYYY-MM-DD');
        var end_date = moment().format('YYYY-MM-DD');

        $('#reportrange span').html("du " + moment().subtract(365, 'days').format('DD/MM/YYYY') + ' au ' + moment().format('DD/MM/YYYY'));

        $('#reportrange').daterangepicker({
            format: 'DD/MM/YYYY',
            startDate: moment().subtract(365, 'days'),
            endDate: moment(),
            minDate: '01/01/2012',
            maxDate: '31/12/2099',
            dateLimit: {days: 29200},
            showDropdowns: true,
            showWeekNumbers: true,
            timePicker: false,
            timePickerIncrement: 1,
            timePicker12Hour: true,
            ranges: {
                "Aujourd'hui": [moment(), moment()],
                'Hier': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Les 7 derniers jours': [moment().subtract(6, 'days'), moment()],
                'Les 30 derniers jours': [moment().subtract(29, 'days'), moment()],
                'Ce mois': [moment().startOf('month'), moment().endOf('month')],
                'Le mois dernier': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            opens: 'right',
            drops: 'down',
            buttonClasses: ['btn', 'btn-sm'],
            applyClass: 'btn-primary',
            cancelClass: 'btn-default',
            separator: ' to ',
            locale: {
                applyLabel: 'Filtrer',
                cancelLabel: 'Annuler',
                fromLabel: 'Du',
                toLabel: 'Au',
                customRangeLabel: 'Filtre personnalisé',
                daysOfWeek: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
                monthNames: ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
                firstDay: 1
            },
        }, function (start, end, label) {
            //console.log(start.toISOString(), end.toISOString(), label);
            $('#reportrange span').html("du " + start.format('DD/MM/YYYY') + ' au ' + end.format('DD/MM/YYYY'));

            start_date = start.format('YYYY-MM-DD');
            end_date = end.format('YYYY-MM-DD');
        });


        // Datatable Date Tri On Date range change
        $('#reportrange').on('apply.daterangepicker', function (ev, picker) {

            start_date = picker.startDate.format('YYYY-MM-DD');
            end_date = picker.endDate.format('YYYY-MM-DD');

        });
    </script>





    <!-- Toastr script -->
    <script src="{% static 'dashboard/js/plugins/toastr/toastr.min.js' %}"></script>


    <script>
        {% if messages %}
            {% for msg in messages %}
                {% if msg.tags == "success" %}
                    toastr.options = {
                        "closeButton": true,
                        "debug": false,
                        "progressBar": true,
                        "preventDuplicates": false,
                        "positionClass": "toast-top-right",
                        "onclick": null,
                        "showDuration": "400",
                        "hideDuration": "1000",
                        "timeOut": "7000",
                        "extendedTimeOut": "1000",
                        "showEasing": "swing",
                        "hideEasing": "linear",
                        "showMethod": "fadeIn",
                        "hideMethod": "fadeOut"
                    };

                    Command: toastr["success"]("{{ msg | safe }}")

                {% endif %}
            {% endfor %}
        {% endif %}
    </script>


    <script>
        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : sParameterName[1];
                }
            }
        };

        $(document).ready(function () {

            var filter_type = getUrlParameter('type');
            var filter_url = getUrlParameter('url');
            var filter_start_date = getUrlParameter('start_date');
            var filter_end_date = getUrlParameter('end_date');
            var filtrer_email = getUrlParameter('email');


            if (filter_type) {
                $('#filter_type').val(filter_type);
            }
            if (filter_url) {
                $('#filter_url').val(filter_url);
            }
            if(filtrer_email){
                $('#filtrer_email').val(filtrer_email);
            }


            if (filter_start_date && filter_end_date) {
                // Format of filter_xxx_date : YYYY-MM-DD
                $("#check_date").attr("checked", "checked");
                var s_date = filter_start_date.split("-"); // [0] = Year, [1] = month, [2] = day
                var e_date = filter_end_date.split("-");
                var new_start_date = s_date[2] + "/" + s_date[1] + "/" + s_date[0];
                var new_end_date = e_date[2] + "/" + e_date[1] + "/" + e_date[0];

                // format : DD/MM/YYYY
                $("#reportrange").data('daterangepicker').setStartDate(new_start_date);
                $("#reportrange").data('daterangepicker').setEndDate(new_end_date);

                $('#reportrange span').html("du " + new_start_date + ' au ' + new_end_date);
            }
        });

        function filter_visits() {
            var filter_type = $('#filter_type').val();
            var filter_url = $('#filter_url').val();
            var filtrer_email = $('#filtrer_email').val();
            var check_date = $("#check_date").is(':checked');

            var i = 1;// Premier paramètre

            get_search = "";


            if (check_date) {
                get_search += "?start_date=" + start_date + "&end_date=" + end_date;
                i++;
            }

            if (filter_type !== "tout") {
                var symbol = (i === 1) ? "?" : "&";
                get_search += symbol + "type=" + filter_type;
                i++;
            }
            if (filter_url !== "") {
                var symbol = (i === 1) ? "?" : "&";
                get_search += symbol + "url=" + filter_url;
            }
            if (filtrer_email !== "") {
                var symbol = (i === 1) ? "?" : "&";
                get_search += symbol + "email=" + filtrer_email;
            }

            if (get_search === "") {
                location.href = '{% url "dashboard:tracking_visites" %}'
            }
            else {
                location.href = '{% url "dashboard:tracking_visites" %}' + get_search
            }
        }
    </script>

















{% endblock scripts %}

